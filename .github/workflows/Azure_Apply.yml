name: 'Azure Resource Group Apply'

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ì²˜ë¦¬í•  ì´ìŠˆ ë²ˆí˜¸'
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  issues: write
  actions: write

jobs:
  # Apply ì‚¬ì „ ê²€ì¦ ì‘ì—…
  Pre-Check:
    uses: ./.github/workflows/Pre-Check.yml
    with:
      issue_number: ${{ github.event.inputs.issue_number }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  terraform-plan:
    needs: Pre-Check
    runs-on: ubuntu-latest
    # ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ì§„í–‰
    if: needs.Pre-Check.outputs.resource_group_exists == 'false'
    
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.Pre-Check.outputs.resource_group }}
      PROJECT_NAME: ${{ needs.Pre-Check.outputs.project_name }}
      # ì‚¬ìš©ì ëª©ë¡ê³¼ GPU í¬ê¸°ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì¶”ê°€
      TF_VAR_user_list: ${{ needs.Pre-Check.outputs.user_list }}
      TF_VAR_gpu_size: ${{ needs.Pre-Check.outputs.gpu_size }}
      TF_VAR_environment: ${{ needs.Pre-Check.outputs.environment }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: 'Check if secrets are set'
        id: check-secrets
        run: |
          SECRETS_STATUS="âœ… ëª¨ë“  Azure ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ AZURE_CLIENT_ID is missing"
            SECRETS_STATUS="âŒ AZURE_CLIENT_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ AZURE_TENANT_ID is missing"
            SECRETS_STATUS="âŒ AZURE_TENANT_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ AZURE_SUBSCRIPTION_ID is missing"
            SECRETS_STATUS="âŒ AZURE_SUBSCRIPTION_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… All secrets are set"
          echo "secrets_status=$SECRETS_STATUS" >> $GITHUB_OUTPUT
      
      - name: 'í”„ë¡œì íŠ¸ë³„ ë°±ì—”ë“œ êµ¬ì„± ìƒì„±'
        run: |
          # main.tfì—ì„œ ë°±ì—”ë“œ êµ¬ì„± ì œê±° í•„ìš”
          # ëŒ€ì‹  ë™ì ìœ¼ë¡œ backend.tf ìƒì„±
          cat > backend.tf << EOF
          terraform {
            backend "azurerm" {
              resource_group_name  = "terraform-state-rg"
              storage_account_name = "tfstatebithumbdev"
              container_name       = "tfstate"
              key                  = "projects/${PROJECT_NAME}/terraform.tfstate"
            }
          }
          EOF
          
          echo "ë°±ì—”ë“œ êµ¬ì„± íŒŒì¼ ìƒì„± ì™„ë£Œ (í”„ë¡œì íŠ¸: ${PROJECT_NAME})"
          cat backend.tf
      
      - name: 'ì‚¬ìš©ì RBAC ë° GPU ì •ì±… ë³€ìˆ˜ íŒŒì¼ ìƒì„±'
        run: |
          # terraform.tfvars íŒŒì¼ ìƒì„±
          cat > terraform.tfvars << EOF
          resource_group_name = "${TF_VAR_resource_group_name}"
          user_list = ${TF_VAR_user_list}
          gpu_size = "${TF_VAR_gpu_size}"
          environment = "${TF_VAR_environment}"
          EOF
          
          echo "ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ:"
          cat terraform.tfvars
      
      - name: 'ì‚¬ìš©ì RBAC ë° GPU ì •ì±… ëª¨ë“ˆ í™•ì¸'
        run: |
          # í•„ìš”í•œ Terraform ëª¨ë“ˆ êµ¬ì¡° í™•ì¸
          if [ ! -f "modules/rbac/main.tf" ]; then
            echo "RBAC ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
            mkdir -p modules/rbac
            
            # RBAC ëª¨ë“ˆ ìƒì„±
            cat > modules/rbac/main.tf << EOF
          variable "resource_group_id" {
            description = "ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ID"
            type        = string
          }
          
          variable "user_list" {
            description = "ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ì‚¬ìš©ì ëª©ë¡ (ì´ë¦„:ì´ë©”ì¼ í˜•ì‹)"
            type        = list(string)
          }
          
          # ì‚¬ìš©ì ì´ë©”ì¼ ì¶”ì¶œ
          locals {
            user_emails = [for user in var.user_list : split(":", user)[1]]
          }
          
          # ì‚¬ìš©ìë³„ ì—­í•  í• ë‹¹
          resource "azurerm_role_assignment" "user_contributor" {
            for_each             = toset(local.user_emails)
            scope                = var.resource_group_id
            role_definition_name = "Contributor"
            principal_id         = each.value
          }
          
          output "assigned_users" {
            value = local.user_emails
          }
          EOF
            
            echo "RBAC ëª¨ë“ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
          
          if [ ! -f "modules/gpu_policy/main.tf" ]; then
            echo "GPU ì •ì±… ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
            mkdir -p modules/gpu_policy
            
            # GPU ì •ì±… ëª¨ë“ˆ ìƒì„±
            cat > modules/gpu_policy/main.tf << EOF
          variable "resource_group_id" {
            description = "ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ID"
            type        = string
          }
          
          variable "gpu_size" {
            description = "í•„ìš”í•œ GPU í¬ê¸° (Tiny, Small, Medium, Large, XLarge)"
            type        = string
            default     = "í•´ë‹¹ ì—†ìŒ"
          }
          
          # GPU í¬ê¸°ë³„ í• ë‹¹ëŸ‰ ë§¤í•‘
          locals {
            gpu_quotas = {
              "Tiny"    = 4
              "Small"   = 8
              "Medium"  = 16
              "Large"   = 24
              "XLarge"  = 32
              "í•´ë‹¹ ì—†ìŒ" = 0
            }
            gpu_quota = lookup(local.gpu_quotas, var.gpu_size, 0)
          }
          
          # GPU í• ë‹¹ëŸ‰ ì •ì±… ì„¤ì •
          resource "azurerm_policy_assignment" "gpu_quota" {
            count                = local.gpu_quota > 0 ? 1 : 0
            name                 = "gpu-quota-policy"
            scope                = var.resource_group_id
            policy_definition_id = "/providers/Microsoft.Authorization/policyDefinitions/5c99bc60-3bcd-475f-b420-5a4abe6eaec4" # ê°€ìƒ ì •ì±… ID (ì‹¤ì œ IDë¡œ ëŒ€ì²´ í•„ìš”)
            parameters           = <<PARAMETERS
          {
            "gpuQuotaValue": {
              "value": ${local.gpu_quota}
            }
          }
          PARAMETERS
          }
          
          output "assigned_gpu_quota" {
            value = local.gpu_quota
          }
          EOF
            
            echo "GPU ì •ì±… ëª¨ë“ˆì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
      
      - name: 'main.tf íŒŒì¼ ì—…ë°ì´íŠ¸'
        run: |
          # main.tf íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ ! -f "main.tf" ]; then
            # main.tf íŒŒì¼ ìƒì„±
            cat > main.tf << EOF
          provider "azurerm" {
            features {}
          }
          
          # ë³€ìˆ˜ ì •ì˜
          variable "resource_group_name" {
            description = "ë°°í¬í•  ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì´ë¦„"
            type        = string
          }
          
          variable "user_list" {
            description = "ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ì‚¬ìš©ì ëª©ë¡"
            type        = list(string)
            default     = []
          }
          
          variable "gpu_size" {
            description = "í•„ìš”í•œ GPU í¬ê¸°"
            type        = string
            default     = "í•´ë‹¹ ì—†ìŒ"
          }
          
          variable "environment" {
            description = "ë°°í¬ í™˜ê²½"
            type        = string
            default     = "ê°œë°œ(Development)"
          }
          
          # ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„±
          resource "azurerm_resource_group" "main" {
            name     = var.resource_group_name
            location = "Korea Central"
            
            tags = {
              Environment = var.environment
              ManagedBy   = "Terraform"
              Project     = replace(var.resource_group_name, "rg-", "")
            }
          }
          
          # RBAC ëª¨ë“ˆ í˜¸ì¶œ
          module "rbac" {
            source           = "./modules/rbac"
            resource_group_id = azurerm_resource_group.main.id
            user_list        = var.user_list
          }
          
          # GPU ì •ì±… ëª¨ë“ˆ í˜¸ì¶œ 
          module "gpu_policy" {
            source           = "./modules/gpu_policy"
            resource_group_id = azurerm_resource_group.main.id
            gpu_size         = var.gpu_size
          }
          
          # ì¶œë ¥ê°’ ì •ì˜
          output "resource_group_id" {
            value = azurerm_resource_group.main.id
          }
          
          output "resource_group_name" {
            value = azurerm_resource_group.main.name
          }
          
          output "assigned_users" {
            value = module.rbac.assigned_users
          }
          
          output "gpu_quota" {
            value = module.gpu_policy.assigned_gpu_quota
          }
          EOF
            
            echo "main.tf íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "main.tf íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”."
          fi
      
      - name: 'Az CLI login with OIDC'
        id: azure-login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Init
        id: tf-init
        run: |
          terraform init
          echo "## Terraform ì´ˆê¸°í™”" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ì´ˆê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
      
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan
          
          # ìš”ì•½ ì¶”ê°€
          echo "## Terraform Plan ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${TF_VAR_resource_group_name}**" >> $GITHUB_STEP_SUMMARY
          echo "- í”„ë¡œì íŠ¸: **${PROJECT_NAME}**" >> $GITHUB_STEP_SUMMARY
          echo "- GPU í¬ê¸°: **${TF_VAR_gpu_size}**" >> $GITHUB_STEP_SUMMARY
          echo "- í™˜ê²½: **${TF_VAR_environment}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… Plan ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 1
      
      - name: Post Plan Result to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = ${{ github.event.inputs.issue_number }};
            
            // GPU í¬ê¸° ì •ë³´
            const gpuSize = "${{ needs.Pre-Check.outputs.gpu_size }}";
            const gpuInfo = gpuSize !== "í•´ë‹¹ ì—†ìŒ" ? `GPU í¬ê¸°: \`${gpuSize}\`` : "GPU í• ë‹¹: ì—†ìŒ";
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## Terraform Plan ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${{ needs.Pre-Check.outputs.resource_group }}\`
              í”„ë¡œì íŠ¸: \`${{ needs.Pre-Check.outputs.project_name }}\`
              ${gpuInfo}
              í™˜ê²½: \`${{ needs.Pre-Check.outputs.environment }}\`
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„± ë° ì‚¬ìš©ì RBAC, GPU ì •ì±…ì´ ê³„íšë˜ì—ˆìŠµë‹ˆë‹¤.
              íŒ€ì¥ë‹˜ì˜ ìŠ¹ì¸ í›„ Applyê°€ ì§„í–‰ë©ë‹ˆë‹¤.`
            });

  terraform-apply:
    needs: [Pre-Check, terraform-plan]
    runs-on: ubuntu-latest
    # ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°ì—ë§Œ ì§„í–‰
    if: needs.Pre-Check.outputs.resource_group_exists == 'false'
    environment: 
      name: production
      url: ${{ github.server_url }}/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}
    outputs:
      approval_status: ${{ steps.get_approval_status.outputs.status }}
      started: ${{ steps.mark-start.outputs.started }}
      
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.Pre-Check.outputs.resource_group }}
      TF_VAR_user_list: ${{ needs.Pre-Check.outputs.user_list }}
      TF_VAR_gpu_size: ${{ needs.Pre-Check.outputs.gpu_size }}
      TF_VAR_environment: ${{ needs.Pre-Check.outputs.environment }}
    
    steps:
      - name: Get Approval Status
        id: get_approval_status
        run: |
          # í™˜ê²½ ë³´í˜¸ ê²€í†  ìƒíƒœ í™•ì¸
          # GitHub Actionsì—ì„œëŠ” ì´ ê°’ì„ ì§ì ‘ ì–»ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê·¸ëƒ¥ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •
          # ì‹¤ì œë¡œëŠ” ì›Œí¬í”Œë¡œìš°ê°€ ì—¬ê¸°ê¹Œì§€ ì§„í–‰ë˜ë©´ ìŠ¹ì¸ëœ ê²ƒì„
          echo "status=approved" >> $GITHUB_OUTPUT
          
          # ìš”ì•½ ì¶”ê°€
          echo "## ìŠ¹ì¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- í™˜ê²½: **production**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ìŠ¹ì¸ë¨" >> $GITHUB_STEP_SUMMARY

      - name: Mark job started
        id: mark-start
        run: echo "started=true" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v3
      
      - name: 'Azure CLI ë¡œê·¸ì¸ (OIDC)'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: 'Terraform ì„¤ì •'
        uses: hashicorp/setup-terraform@v2
      
      - name: 'ì‚¬ìš©ì RBAC ë° GPU ì •ì±… ëª¨ë“ˆ í™•ì¸'
        run: |
          # modules ë””ë ‰í† ë¦¬ì™€ í•„ìš”í•œ ëª¨ë“ˆì´ ìˆëŠ”ì§€ í™•ì¸
          mkdir -p modules/rbac modules/gpu_policy
          
          # RBAC ëª¨ë“ˆ ìƒì„±
          cat > modules/rbac/main.tf << EOF
          variable "resource_group_id" {
            description = "ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ID"
            type        = string
          }
          
          variable "user_list" {
            description = "ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ì‚¬ìš©ì ëª©ë¡ (ì´ë¦„:ì´ë©”ì¼ í˜•ì‹)"
            type        = list(string)
          }
          
          # ì‚¬ìš©ì ì´ë©”ì¼ ì¶”ì¶œ
          locals {
            user_emails = [for user in var.user_list : split(":", user)[1]]
          }
          
          # ì‚¬ìš©ìë³„ ì—­í•  í• ë‹¹
          resource "azurerm_role_assignment" "user_contributor" {
            for_each             = toset(local.user_emails)
            scope                = var.resource_group_id
            role_definition_name = "Contributor"
            principal_id         = each.value
          }
          
          output "assigned_users" {
            value = local.user_emails
          }
          EOF
          
          # GPU ì •ì±… ëª¨ë“ˆ ìƒì„±
          cat > modules/gpu_policy/main.tf << EOF
          variable "resource_group_id" {
            description = "ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ID"
            type        = string
          }
          
          variable "gpu_size" {
            description = "í•„ìš”í•œ GPU í¬ê¸° (Tiny, Small, Medium, Large, XLarge)"
            type        = string
            default     = "í•´ë‹¹ ì—†ìŒ"
          }
          
          # GPU í¬ê¸°ë³„ í• ë‹¹ëŸ‰ ë§¤í•‘
          locals {
            gpu_quotas = {
              "Tiny"    = 4
              "Small"   = 8
              "Medium"  = 16
              "Large"   = 24
              "XLarge"  = 32
              "í•´ë‹¹ ì—†ìŒ" = 0
            }
            gpu_quota = lookup(local.gpu_quotas, var.gpu_size, 0)
          }
          
          # GPU í• ë‹¹ëŸ‰ ì •ì±… ì„¤ì •
          resource "azurerm_policy_assignment" "gpu_quota" {
            count                = local.gpu_quota > 0 ? 1 : 0
            name                 = "gpu-quota-policy"
            scope                = var.resource_group_id
            policy_definition_id = "/providers/Microsoft.Authorization/policyDefinitions/5c99bc60-3bcd-475f-b420-5a4abe6eaec4" # ê°€ìƒ ì •ì±… ID (ì‹¤ì œ IDë¡œ ëŒ€ì²´ í•„ìš”)
            parameters           = <<PARAMETERS
          {
            "gpuQuotaValue": {
              "value": ${local.gpu_quota}
            }
          }
          PARAMETERS
          }
          
          output "assigned_gpu_quota" {
            value = local.gpu_quota
          }
          EOF
      
      - name: 'ë©”ì¸ Terraform íŒŒì¼ ìƒì„±'
        run: |
          # main.tf íŒŒì¼ ìƒì„±
          cat > main.tf << EOF
          provider "azurerm" {
            features {}
          }
          
          # ë³€ìˆ˜ ì •ì˜
          variable "resource_group_name" {
            description = "ë°°í¬í•  ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì´ë¦„"
            type        = string
          }
          
          variable "user_list" {
            description = "ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•  ì‚¬ìš©ì ëª©ë¡"
            type        = list(string)
            default     = []
          }
          
          variable "gpu_size" {
            description = "í•„ìš”í•œ GPU í¬ê¸°"
            type        = string
            default     = "í•´ë‹¹ ì—†ìŒ"
          }
          
          variable "environment" {
            description = "ë°°í¬ í™˜ê²½"
            type        = string
            default     = "ê°œë°œ(Development)"
          }
          
          # ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„±
          resource "azurerm_resource_group" "main" {
            name     = var.resource_group_name
            location = "Korea Central"
            
            tags = {
              Environment = var.environment
              ManagedBy   = "Terraform"
              Project     = replace(var.resource_group_name, "rg-", "")
            }
          }
          
          # RBAC ëª¨ë“ˆ í˜¸ì¶œ
          module "rbac" {
            source           = "./modules/rbac"
            resource_group_id = azurerm_resource_group.main.id
            user_list        = var.user_list
          }
          
          # GPU ì •ì±… ëª¨ë“ˆ í˜¸ì¶œ 
          module "gpu_policy" {
            source           = "./modules/gpu_policy"
            resource_group_id = azurerm_resource_group.main.id
            gpu_size         = var.gpu_size
          }
          
          # ì¶œë ¥ê°’ ì •ì˜
          output "resource_group_id" {
            value = azurerm_resource_group.main.id
          }
          
          output "resource_group_name" {
            value = azurerm_resource_group.main.name
          }
          
          output "assigned_users" {
            value = module.rbac.assigned_users
          }
          
          output "gpu_quota" {
            value = module.gpu_policy.assigned_gpu_quota
          }
          EOF
          
          # ë°±ì—”ë“œ êµ¬ì„± íŒŒì¼ ìƒì„±
          cat > backend.tf << EOF
          terraform {
            backend "azurerm" {
              resource_group_name  = "terraform-state-rg"
              storage_account_name = "tfstatebithumbdev"
              container_name       = "tfstate"
              key                  = "projects/${{ needs.Pre-Check.outputs.project_name }}/terraform.tfstate"
            }
          }
          EOF
          
          # ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > terraform.tfvars << EOF
          resource_group_name = "${TF_VAR_resource_group_name}"
          user_list = ${TF_VAR_user_list}
          gpu_size = "${TF_VAR_gpu_size}"
          environment = "${TF_VAR_environment}"
          EOF
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          
          # ìš”ì•½ ì‹œì‘
          echo "## Terraform Apply ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${TF_VAR_resource_group_name}**" >> $GITHUB_STEP_SUMMARY
          echo "- í”„ë¡œì íŠ¸: **${{ needs.Pre-Check.outputs.project_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "- GPU í¬ê¸°: **${TF_VAR_gpu_size}**" >> $GITHUB_STEP_SUMMARY
          echo "- í™˜ê²½: **${TF_VAR_environment}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë¨" >> $GITHUB_STEP_SUMMARY
          
          # ì‚¬ìš©ì RBAC ì •ë³´ ì¶œë ¥
          echo "### ì ‘ê·¼ ê¶Œí•œ ë°°í¬ (RBAC)" >> $GITHUB_STEP_SUMMARY
          echo "- ê¶Œí•œì„ ë°›ì€ ì‚¬ìš©ì: $(terraform output -json assigned_users)" >> $GITHUB_STEP_SUMMARY
          
          # GPU í• ë‹¹ëŸ‰ ì •ë³´ ì¶œë ¥
          echo "### GPU í• ë‹¹ëŸ‰ ì •ì±…" >> $GITHUB_STEP_SUMMARY
          echo "- í• ë‹¹ëœ GPU ìˆ˜: $(terraform output -raw gpu_quota)" >> $GITHUB_STEP_SUMMARY
          
          # ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ ëª©ë¡ ì¶œë ¥
          echo "### ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> $GITHUB_STEP_SUMMARY
          terraform state list | while read -r resource; do
            echo "- \`$resource\`" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: Post Apply Result to Issue
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = ${{ github.event.inputs.issue_number }};
            const resourceGroupName = "${{ needs.Pre-Check.outputs.resource_group }}";
            const subscriptionId = "${{ secrets.AZURE_SUBSCRIPTION_ID }}";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Azure í¬í„¸ ë§í¬ ìƒì„±
            const portalLink = `https://portal.azure.com/#@/resource/subscriptions/${subscriptionId}/resourceGroups/${resourceGroupName}/overview`;
            
            // GPU í¬ê¸° ì •ë³´
            const gpuSize = "${{ needs.Pre-Check.outputs.gpu_size }}";
            const gpuInfo = gpuSize !== "í•´ë‹¹ ì—†ìŒ" ? `- GPU í• ë‹¹ëŸ‰: \`${gpuSize}\`` : "- GPU í• ë‹¹: ì—†ìŒ";
            
            // 1. ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: owner,
              repo: repo,
              issue_number: issue_number,
              body: `## Terraform Apply ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${resourceGroupName}\`
              í”„ë¡œì íŠ¸: \`${{ needs.Pre-Check.outputs.project_name }}\`
              ${gpuInfo}
              í™˜ê²½: \`${{ needs.Pre-Check.outputs.environment }}\`
              
              ### ë°°í¬ ë‚´ìš©:
              - ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„± ì™„ë£Œ
              - ì‚¬ìš©ì RBAC ê¶Œí•œ ì„¤ì • ì™„ë£Œ
              - GPU í• ë‹¹ëŸ‰ ì •ì±… ì„¤ì • ì™„ë£Œ
              
              ### ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ì ‘ì†
              [Azure í¬í„¸ì—ì„œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ë³´ê¸°](${portalLink})`
            });
            
            // 2. ëª¨ë“  ë¼ë²¨ ì œê±°
            try {
              // í˜„ì¬ ì´ìŠˆì˜ ëª¨ë“  ë¼ë²¨ ì¡°íšŒ
              const issueData = await github.rest.issues.get({
                owner, repo, issue_number
              });
              
              // ì´ìŠˆì— ë‹¬ë ¤ìˆëŠ” ëª¨ë“  ë¼ë²¨ ì œê±°
              if (issueData.data.labels && issueData.data.labels.length > 0) {
                for (const label of issueData.data.labels) {
                  await github.rest.issues.removeLabel({
                    owner, repo, issue_number,
                    name: label.name
                  });
                }
                console.log("ëª¨ë“  ë¼ë²¨ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                console.log("ì œê±°í•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.");
              }
              
              // 3. "Completed" ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner, repo, issue_number,
                labels: ['Completed']
              });
              console.log("Completed ë¼ë²¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
              
            } catch (e) {
              console.log("ë¼ë²¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e.message);
            }

  handle-rejection:
    needs: [Pre-Check, terraform-plan, terraform-apply]
    # ìˆ˜ì •ëœ ì¡°ê±´: terraform-applyê°€ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤íŒ¨í•˜ê±°ë‚˜ ì·¨ì†Œëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: >
      always() && 
      needs.Pre-Check.outputs.resource_group_exists == 'false' &&
      needs.terraform-plan.result == 'success' &&
      (needs.terraform-apply.result == 'failure' || 
       needs.terraform-apply.result == 'cancelled' || 
       needs.terraform-apply.result == 'skipped') && 
      needs.terraform-apply.outputs.started != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update Summary for Rejection
        run: |
          echo "## ë°°í¬ ê±°ì ˆ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${{ needs.Pre-Check.outputs.resource_group }}**" >> $GITHUB_STEP_SUMMARY
          echo "- í”„ë¡œì íŠ¸: **${{ needs.Pre-Check.outputs.project_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âŒ ë°°í¬ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ì¡°ì¹˜: ì´ìŠˆì— ê±°ì ˆ ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const issue_number = ${{ github.event.inputs.issue_number }};

            // 1) ê±°ì ˆ ì½”ë©˜íŠ¸
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `## Terraform Apply ê±°ì ˆë¨ âŒ

              íŒ€ì¥ë‹˜ê»˜ì„œ ë°°í¬ ìš”ì²­ì„ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤.`
            });

            // 2) ê¸°ì¡´ resource_group ë¼ë²¨ ì œê±°
            try {
              // í˜„ì¬ ì´ìŠˆì˜ ëª¨ë“  ë¼ë²¨ ì¡°íšŒ
              const issueData = await github.rest.issues.get({
                owner, repo, issue_number
              });
              
              // ì´ìŠˆì— ë‹¬ë ¤ìˆëŠ” ëª¨ë“  ë¼ë²¨ ì œê±°
              if (issueData.data.labels && issueData.data.labels.length > 0) {
                for (const label of issueData.data.labels) {
                  await github.rest.issues.removeLabel({
                    owner, repo, issue_number,
                    name: label.name
                  });
                }
                console.log("ëª¨ë“  ë¼ë²¨ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.");
              } else {
                console.log("ì œê±°í•  ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.");
              }
            } catch (e) {
              console.log("ë¼ë²¨ ì œê±° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e.message);
            }

            // 3) ìƒíƒœ í‘œì‹œìš© ë¼ë²¨ ì¶”ê°€(ì„ íƒ)
            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ['Rejected']
            });

  cleanup-artifacts:
    needs: [Pre-Check, terraform-plan, handle-rejection]
    if: >
      always() &&
      needs.terraform-plan.result != 'skipped' 
    runs-on: ubuntu-latest

    # ğŸŸ¢ ì•„í‹°íŒ©íŠ¸ ì‚­ì œìš© API í˜¸ì¶œ ê¶Œí•œ
    permissions:
      actions: write

    steps:
      - name: Update Summary for Cleanup
        run: |
          echo "## ì•„í‹°íŒ©íŠ¸ ì •ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "- ì‘ì—…: terraform-plan ì•„í‹°íŒ©íŠ¸ ì •ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: ì§„í–‰ ì¤‘..." >> $GITHUB_STEP_SUMMARY

      - name: List available artifacts
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            console.log('Available artifacts:');
            for (const artifact of artifacts.data.artifacts) {
              console.log(`- ${artifact.name} (ID: ${artifact.id})`);
            }
            
      - name: Delete terraform-plan artifact
        id: delete-artifact
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return artifact.name === "terraform-plan"
            })[0];
            
            let deleteStatus = "âŒ ì•„í‹°íŒ©íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
            
            if (matchArtifact) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id
              });
              console.log(`Successfully deleted artifact: terraform-plan (ID: ${matchArtifact.id})`);
              deleteStatus = "âœ… ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë¨";
            } else {
              console.log('No terraform-plan artifact found');
            }
            
            // ìš”ì•½ ì—…ë°ì´íŠ¸
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `- terraform-plan: **${deleteStatus}**\n`);
            
      - name: Final Workflow Summary
        run: |
          echo "## ì›Œí¬í”Œë¡œìš° ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì „ì²´ ìƒíƒœ: âœ… ì›Œí¬í”Œë¡œìš° ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY