name: 'Resource Group Issue Workflow'

on:
  issues:
    types: [labeled]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  check-label-and-extract-resource-group:
    runs-on: ubuntu-latest
    # ë¼ë²¨ ì´ë²¤íŠ¸ì¸ ê²½ìš° 'resource_group' ë¼ë²¨ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.label.name == 'resource_group' || contains(github.event.issue.labels.*.name, 'resource_group')
    outputs:
      resource_group: ${{ steps.get-resource-group.outputs.resource_group }}
    steps:
      - name: Check for Resource Group Label
        id: check-label
        run: |
          # ì´ìŠˆì— 'resource group' ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸
          IS_LABELED=false
          
          # ì´ë²¤íŠ¸ ìœ í˜• í™•ì¸
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ github.event.action }}" = "labeled" ]; then
            # ë¼ë²¨ ì´ë²¤íŠ¸ì¸ ê²½ìš°
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "resource_group" ]; then
              IS_LABELED=true
            fi
          else
            # ì´ìŠˆ ì˜¤í”ˆ ì´ë²¤íŠ¸ì¸ ê²½ìš° ë¼ë²¨ ëª©ë¡ í™•ì¸
            LABELS="${{ toJSON(github.event.issue.labels) }}"
            if [[ $LABELS == *"resource_group"* ]]; then
              IS_LABELED=true
            fi
          fi
          
          if [ "$IS_LABELED" = "false" ]; then
            echo "âŒ This workflow only runs with the 'resource_group' label."
            exit 1
          fi
          
          echo "âœ… Resource Group label detected."
      
      - name: Extract Resource Group from Issue (Issue Forms)
        id: get-resource-group
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            
            // ì´ìŠˆ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const issue = await github.rest.issues.get({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue_number
            });
            
            let resourceGroup = null;
            const issueBody = issue.data.body;
            
            // GitHub Issue Forms í˜•ì‹(structured forms) íŒŒì‹±
            // ì´ìŠˆ í…œí”Œë¦¿ì˜ input field "id: resource-group-name"ê³¼ "label: ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…" ì°¾ê¸°
            if (issueBody) {
              // ë°©ë²• 1: labelë¡œ ì°¾ê¸°
              const rgLabelMatch = issueBody.match(/###\s+ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…\s*([\s\S]*?)(?=###|$)/);
              if (rgLabelMatch && rgLabelMatch[1]) {
                resourceGroup = rgLabelMatch[1].trim();
              }
              
              // ë°©ë²• 2: ì—¬ëŸ¬ ê°€ëŠ¥í•œ í˜•ì‹ ê³ ë ¤í•˜ê¸°
              if (!resourceGroup) {
                const possiblePatterns = [
                  /###\s+ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…\s*([\s\S]*?)(?=###|$)/,
                  /ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…:?\s*([a-zA-Z0-9_-]+)/i,
                  /ë¦¬ì†ŒìŠ¤\s+ê·¸ë£¹:?\s*([a-zA-Z0-9_-]+)/i,
                  /resource\s+group:?\s*([a-zA-Z0-9_-]+)/i,
                  /ë°°í¬í• \s+ë¦¬ì†ŒìŠ¤\s+ê·¸ë£¹ì˜\s+ì´ë¦„.*\n\s*([a-zA-Z0-9_-]+)/i
                ];
                
                for (const pattern of possiblePatterns) {
                  const match = issueBody.match(pattern);
                  if (match && match[1]) {
                    resourceGroup = match[1].trim();
                    break;
                  }
                }
              }
            }
            
            if (!resourceGroup) {
              console.log('âŒ Resource Group name not found in the issue body using standard patterns');
              
              // ë§ˆì§€ë§‰ ì‹œë„: ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ëª… ì°¾ê¸°
              const lines = issueBody.split('\n');
              for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // ì•ŒíŒŒë²³, ìˆ«ì, í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´ë¡œ êµ¬ì„±ëœ ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ëª… íŒ¨í„´
                const rgNamePattern = /^[a-zA-Z0-9][a-zA-Z0-9_-]{2,62}$/;
                
                if (rgNamePattern.test(line) && line.indexOf(' ') === -1) {
                  // ê³µë°± ì—†ëŠ” ì í•©í•œ ëª…ëª… ê·œì¹™ì„ ê°€ì§„ ì¤„ì´ ìˆì„ ê²½ìš°
                  resourceGroup = line;
                  console.log(`âœ… Found potential resource group name: ${resourceGroup}`);
                  break;
                }
              }
            }
            
            if (!resourceGroup) {
              core.setFailed('Resource Group name not found in the issue body');
              return;
            }
            
            console.log(`âœ… Resource Group name: ${resourceGroup}`);
            core.setOutput('resource_group', resourceGroup);

  terraform-plan:
    needs: check-label-and-extract-resource-group
    runs-on: ubuntu-latest
    
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.check-label-and-extract-resource-group.outputs.resource_group }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: 'Check if secrets are set'
        run: |
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ AZURE_CLIENT_ID is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ AZURE_TENANT_ID is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ AZURE_SUBSCRIPTION_ID is missing"
            exit 1
          fi
          echo "âœ… All secrets are set"
      
      - name: 'Az CLI login with OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Plan
        id: plan
        run: terraform plan -var="resource_group_name=${TF_VAR_resource_group_name}" -out=tfplan
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 1
      
      - name: Post Plan Result to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## Terraform Plan ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${{ needs.check-label-and-extract-resource-group.outputs.resource_group }}\`
              
              Planì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒ€ì¥ë‹˜ì˜ ìŠ¹ì¸ í›„ Applyê°€ ì§„í–‰ë©ë‹ˆë‹¤.`
            });

  terraform-apply:
    needs: [check-label-and-extract-resource-group, terraform-plan]
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: ${{ github.server_url }}/${{ github.repository }}/issues/${{ github.event.issue.number }}
    outputs:
      approval_status: ${{ steps.get_approval_status.outputs.status }}
      started: ${{ steps.mark-start.outputs.started }}
      
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.check-label-and-extract-resource-group.outputs.resource_group }}
    
    steps:
      - name: Get Approval Status
        id: get_approval_status
        run: |
          # í™˜ê²½ ë³´í˜¸ ê²€í†  ìƒíƒœ í™•ì¸
          # GitHub Actionsì—ì„œëŠ” ì´ ê°’ì„ ì§ì ‘ ì–»ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê·¸ëƒ¥ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •
          # ì‹¤ì œë¡œëŠ” ì›Œí¬í”Œë¡œìš°ê°€ ì—¬ê¸°ê¹Œì§€ ì§„í–‰ë˜ë©´ ìŠ¹ì¸ëœ ê²ƒì„
          echo "status=approved" >> $GITHUB_OUTPUT

      - name: Mark job started
        id: mark-start
        run: echo "started=true" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v3
      
      - name: 'Az CLI login with OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
      
      - name: Post Apply Result to Issue
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## Terraform Apply ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${{ needs.check-label-and-extract-resource-group.outputs.resource_group }}\` 
              ì¸í”„ë¼ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`
            });

  handle-rejection:
    needs: terraform-apply
    # ìˆ˜ì •ëœ ì¡°ê±´: terraform-applyê°€ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤íŒ¨í•˜ê±°ë‚˜ ì·¨ì†Œëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: >
      always() && 
      (needs.terraform-apply.result == 'failure' || 
       needs.terraform-apply.result == 'cancelled' || 
       needs.terraform-apply.result == 'skipped') && 
      needs.terraform-apply.outputs.started != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.payload.issue.number;

            // 1) ê±°ì ˆ ì½”ë©˜íŠ¸
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `## Terraform Apply ê±°ì ˆë¨ âŒ

              íŒ€ì¥ë‹˜ì´ ë°°í¬ ìš”ì²­ì„ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤.  
              ì´ìŠˆ ë‚´ìš©ì„ ìˆ˜ì •í•œ ë’¤ **'resource_group' ë¼ë²¨ì„ ë‹¤ì‹œ ë‹¬ì•„** ì¬ìš”ì²­í•´ ì£¼ì„¸ìš”.`
            });

            // 2) ê¸°ì¡´ resource_group ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner, repo, issue_number,
                name: 'resource_group'
              });
            } catch (e) {
              // ì´ë¯¸ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
            }

            // 3) ìƒíƒœ í‘œì‹œìš© ë¼ë²¨ ì¶”ê°€(ì„ íƒ)
            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ['deployment-rejected']
            });

  cleanup-artifacts:
    needs: [terraform-plan, handle-rejection]
    # terraform-plan ì´ ì‹¤ì œë¡œ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: always() && needs.terraform-plan.result == 'success'
    runs-on: ubuntu-latest

    # ğŸŸ¢ ì•„í‹°íŒ©íŠ¸ ì‚­ì œìš© API í˜¸ì¶œ ê¶Œí•œ
    permissions:
      actions: write

    steps:
      - name: Remove Terraform Plan Artifact
        uses: geekyeggo/delete-artifact@v2
        with:
          name: terraform-plan
          failOnError: false   # ì´ë¦„ ë¶ˆì¼ì¹˜ ì‹œì—ë„ ì›Œí¬í”Œë¡œ ì‹¤íŒ¨ë¡œ ë§Œë“¤ì§€ ì•ŠìŒ