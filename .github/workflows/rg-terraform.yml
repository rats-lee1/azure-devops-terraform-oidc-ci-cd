name: 'Resource Group Issue Workflow'

on:
  issues:
    types: [labeled]
  workflow_dispatch:

concurrency:
  group: issue-${{ github.event.issue.number }}
  cancel-in-progress: true
  
permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  pre-checking:
    runs-on: ubuntu-latest
    # ë¼ë²¨ ì´ë²¤íŠ¸ì¸ ê²½ìš° 'resource_group' ë¼ë²¨ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.label.name == 'resource_group' || contains(github.event.issue.labels.*.name, 'resource_group')
    outputs:
      resource_group: ${{ steps.get-resource-group.outputs.resource_group }}
      poc_name: ${{ steps.extract-poc-info.outputs.poc_name }}
      has_poc: ${{ steps.extract-poc-info.outputs.has_poc }}
    steps:
      - name: Check for Resource Group Label
        id: check-label
        run: |
          # ì´ìŠˆì— 'resource group' ë¼ë²¨ì´ ìˆëŠ”ì§€ í™•ì¸
          IS_LABELED=false
          
          # ì´ë²¤íŠ¸ ìœ í˜• í™•ì¸
          if [ "${{ github.event_name }}" = "issues" ] && [ "${{ github.event.action }}" = "labeled" ]; then
            # ë¼ë²¨ ì´ë²¤íŠ¸ì¸ ê²½ìš°
            LABEL="${{ github.event.label.name }}"
            if [ "$LABEL" = "resource_group" ]; then
              IS_LABELED=true
            fi
          else
            # ì´ìŠˆ ì˜¤í”ˆ ì´ë²¤íŠ¸ì¸ ê²½ìš° ë¼ë²¨ ëª©ë¡ í™•ì¸
            LABELS="${{ toJSON(github.event.issue.labels) }}"
            if [[ $LABELS == *"resource_group"* ]]; then
              IS_LABELED=true
            fi
          fi
          
          if [ "$IS_LABELED" = "false" ]; then
            echo "âŒ This workflow only runs with the 'resource_group' label."
            exit 1
          fi
          
          echo "âœ… Resource Group label detected."
      
      - name: Extract Resource Group from Issue (Issue Forms)
        id: get-resource-group
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            const repo = context.repo;
            
            // ì´ìŠˆ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const issue = await github.rest.issues.get({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue_number
            });
            
            let resourceGroup = null;
            const issueBody = issue.data.body;
            
            // GitHub Issue Forms í˜•ì‹(structured forms) íŒŒì‹±
            // ì´ìŠˆ í…œí”Œë¦¿ì˜ input field "id: resource-group-name"ê³¼ "label: ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…" ì°¾ê¸°
            if (issueBody) {
              // ë°©ë²• 1: labelë¡œ ì°¾ê¸°
              const rgLabelMatch = issueBody.match(/###\s+ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…\s*([\s\S]*?)(?=###|$)/);
              if (rgLabelMatch && rgLabelMatch[1]) {
                resourceGroup = rgLabelMatch[1].trim();
              }
              
              // ë°©ë²• 2: ì—¬ëŸ¬ ê°€ëŠ¥í•œ í˜•ì‹ ê³ ë ¤í•˜ê¸°
              if (!resourceGroup) {
                const possiblePatterns = [
                  /###\s+ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…\s*([\s\S]*?)(?=###|$)/,
                  /ë¦¬ì†ŒìŠ¤_ê·¸ë£¹ëª…:?\s*([a-zA-Z0-9_-]+)/i,
                  /ë¦¬ì†ŒìŠ¤\s+ê·¸ë£¹:?\s*([a-zA-Z0-9_-]+)/i,
                  /resource\s+group:?\s*([a-zA-Z0-9_-]+)/i,
                  /ë°°í¬í• \s+ë¦¬ì†ŒìŠ¤\s+ê·¸ë£¹ì˜\s+ì´ë¦„.*\n\s*([a-zA-Z0-9_-]+)/i
                ];
                
                for (const pattern of possiblePatterns) {
                  const match = issueBody.match(pattern);
                  if (match && match[1]) {
                    resourceGroup = match[1].trim();
                    break;
                  }
                }
              }
            }
            
            if (!resourceGroup) {
              console.log('âŒ Resource Group name not found in the issue body using standard patterns');
              
              // ë§ˆì§€ë§‰ ì‹œë„: ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ëª… ì°¾ê¸°
              const lines = issueBody.split('\n');
              for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // ì•ŒíŒŒë²³, ìˆ«ì, í•˜ì´í”ˆ, ì–¸ë”ìŠ¤ì½”ì–´ë¡œ êµ¬ì„±ëœ ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ëª… íŒ¨í„´
                const rgNamePattern = /^[a-zA-Z0-9][a-zA-Z0-9_-]{2,62}$/;
                
                if (rgNamePattern.test(line) && line.indexOf(' ') === -1) {
                  // ê³µë°± ì—†ëŠ” ì í•©í•œ ëª…ëª… ê·œì¹™ì„ ê°€ì§„ ì¤„ì´ ìˆì„ ê²½ìš°
                  resourceGroup = line;
                  console.log(`âœ… Found potential resource group name: ${resourceGroup}`);
                  break;
                }
              }
            }
            
            if (!resourceGroup) {
              core.setFailed('Resource Group name not found in the issue body');
              return;
            }
            
            console.log(`âœ… Resource Group name: ${resourceGroup}`);
            core.setOutput('resource_group', resourceGroup);

      - name: Extract POC from Labels
        id: extract-poc-info
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log(`ì´ìŠˆ #${context.payload.issue.number} POC ì •ë³´ ì¶”ì¶œ ì¤‘`);
            
            try {
              // ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number
              });
              
              // ì´ìŠˆ ë¼ë²¨ í™•ì¸
              const labels = issue.data.labels || [];
              console.log(`ì´ìŠˆì— ì´ ${labels.length}ê°œì˜ ë¼ë²¨ì´ ìˆìŠµë‹ˆë‹¤.`);
              
              // POC ë¼ë²¨ ì°¾ê¸° (POC: ë¡œ ì‹œì‘í•˜ëŠ” ë¼ë²¨)
              const pocLabels = labels.filter(label => {
                const labelName = label.name || '';
                return labelName.startsWith('POC:');
              });
              
              console.log(`${pocLabels.length}ê°œì˜ POC ë¼ë²¨ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              
              let hasPOC = false;
              let pocName = '';
              
              if (pocLabels.length > 0) {
                // POC ë¼ë²¨ ì •ë³´ ì¶”ì¶œ
                const pocInfo = pocLabels.map(label => {
                  const labelName = label.name;
                  const pocName = labelName.substring(4).trim(); // "POC:" ë¶€ë¶„ ì œê±°
                  return {
                    fullLabel: labelName,
                    pocName: pocName,
                    color: label.color
                  };
                });
                
                console.log('ë°œê²¬ëœ POC ì •ë³´:', JSON.stringify(pocInfo, null, 2));
                
                // ì´ìŠˆì— POC ì •ë³´ ì½”ë©˜íŠ¸ ì¶”ê°€
                let comment = '### ì´ ì´ìŠˆì— ì—°ê²°ëœ POC ì •ë³´:\n\n';
                
                pocInfo.forEach(poc => {
                  comment += `- **${poc.pocName}** (ë¼ë²¨: \`${poc.fullLabel}\`)\n`;
                });
                
                hasPOC = true;
                pocName = pocInfo[0].pocName; // ì²« ë²ˆì§¸ POC ì´ë¦„ ì‚¬ìš©
                
                // ê¸°ì¡´ ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number
                });
                
                // ê°™ì€ ë´‡ì´ ì‘ì„±í•œ ê¸°ì¡´ POC ì •ë³´ ì½”ë©˜íŠ¸ ì°¾ê¸°
                const botComments = comments.data.filter(comment => {
                  return comment.user.type === 'Bot' && 
                         comment.body.includes('ì´ ì´ìŠˆì— ì—°ê²°ëœ POC ì •ë³´:');
                });
                
                if (botComments.length > 0) {
                  // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: botComments[0].id,
                    body: comment
                  });
                  console.log('ê¸°ì¡´ POC ì •ë³´ ì½”ë©˜íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                  // ìƒˆ ì½”ë©˜íŠ¸ ì‘ì„±
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.issue.number,
                    body: comment
                  });
                  console.log('POC ì •ë³´ ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
              } else {
                console.log('ì´ ì´ìŠˆì—ëŠ” POC ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                hasPOC = false;
                
                // POCê°€ ì—†ë‹¤ëŠ” ì½”ë©˜íŠ¸ ì¶”ê°€
                const noPocComment = '### âš ï¸ í”„ë¡œì íŠ¸ ì •ë³´ ëˆ„ë½\n\nì´ ì´ìŠˆì— POC ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì ì ˆí•œ POC ë¼ë²¨(`POC:ì´ë¦„`)ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
                
                // ê¸°ì¡´ ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number
                });
                
                // ê¸°ì¡´ POC ì •ë³´ ì½”ë©˜íŠ¸ ì°¾ê¸°
                const pocComments = comments.data.filter(comment => {
                  return comment.user.type === 'Bot' && 
                         (comment.body.includes('ì´ ì´ìŠˆì— ì—°ê²°ëœ POC ì •ë³´:') || 
                          comment.body.includes('âš ï¸ í”„ë¡œì íŠ¸ ì •ë³´ ëˆ„ë½'));
                });
                
                if (pocComments.length > 0) {
                  // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: pocComments[0].id,
                    body: noPocComment
                  });
                  console.log('ê¸°ì¡´ ì½”ë©˜íŠ¸ê°€ POC ëˆ„ë½ ë©”ì‹œì§€ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                  // ìƒˆ ì½”ë©˜íŠ¸ ì‘ì„±
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.issue.number,
                    body: noPocComment
                  });
                  console.log('POC ì •ë³´ ëˆ„ë½ ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
              }
              
              // ì¶œë ¥ ì„¤ì •
              core.setOutput('has_poc', hasPOC.toString());
              core.setOutput('poc_name', pocName);
              
            } catch (error) {
              console.error('POC ì •ë³´ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error.message);
              core.setOutput('has_poc', 'false');
              core.setOutput('poc_name', '');
              
              // ì˜¤ë¥˜ ì •ë³´ë¥¼ ì´ìŠˆì— ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  body: `### âŒ POC ë¼ë²¨ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ\n\n\`\`\`\n${error.message}\n\`\`\``
                });
              } catch (commentError) {
                console.error('ì½”ë©˜íŠ¸ ì¶”ê°€ ì¤‘ ì¶”ê°€ ì˜¤ë¥˜ ë°œìƒ:', commentError.message);
              }
            }
      
      - name: Add Resource Group Summary
        run: |
          echo "## ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ë° POC ê²€ì¦ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì´ìŠˆ ë²ˆí˜¸: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹ë³„ëœ ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${{ steps.get-resource-group.outputs.resource_group }}**" >> $GITHUB_STEP_SUMMARY
          echo "- POC ì •ë³´: **${{ steps.extract-poc-info.outputs.has_poc == 'true' && steps.extract-poc-info.outputs.poc_name || 'ì—†ìŒ' }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY

  terraform-plan:
    needs: pre-checking
    runs-on: ubuntu-latest
    # POC ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì§„í–‰
    if: needs.pre-checking.outputs.has_poc == 'true'
    
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.pre-checking.outputs.resource_group }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: 'Check if secrets are set'
        id: check-secrets
        run: |
          SECRETS_STATUS="âœ… ëª¨ë“  Azure ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ AZURE_CLIENT_ID is missing"
            SECRETS_STATUS="âŒ AZURE_CLIENT_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ AZURE_TENANT_ID is missing"
            SECRETS_STATUS="âŒ AZURE_TENANT_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ AZURE_SUBSCRIPTION_ID is missing"
            SECRETS_STATUS="âŒ AZURE_SUBSCRIPTION_IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… All secrets are set"
          echo "secrets_status=$SECRETS_STATUS" >> $GITHUB_OUTPUT
      
      - name: 'Az CLI login with OIDC'
        id: azure-login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Init
        id: tf-init
        run: |
          terraform init
          echo "## Terraform ì´ˆê¸°í™”" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ì´ˆê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
      
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var="resource_group_name=${TF_VAR_resource_group_name}" -out=tfplan
          
          # Plan ìƒíƒœ ìº¡ì²˜ (ê°œì„ ëœ ë°©ì‹)
          PLAN_OUTPUT=$(terraform show -no-color tfplan)
          
          # ë¦¬ì†ŒìŠ¤ ë³€ê²½ ê³„ì‚° ë°©ì‹ ê°œì„ 
          RESOURCES_TO_ADD=$(echo "$PLAN_OUTPUT" | grep -E '^\s*\+\s' | wc -l)
          RESOURCES_TO_CHANGE=$(echo "$PLAN_OUTPUT" | grep -E '^\s*~\s' | wc -l)
          RESOURCES_TO_DESTROY=$(echo "$PLAN_OUTPUT" | grep -E '^\s*-\s' | wc -l)
          
          # ìš”ì•½ ì¶”ê°€
          echo "## Terraform Plan ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${TF_VAR_resource_group_name}**" >> $GITHUB_STEP_SUMMARY
          echo "- POC: **${{ needs.pre-checking.outputs.poc_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… Plan ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: tfplan
          retention-days: 1
      
      - name: Post Plan Result to Issue
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## Terraform Plan ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${{ needs.pre-checking.outputs.resource_group }}\`
              POC: \`${{ needs.pre-checking.outputs.poc_name }}\`
              
              Planì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. íŒ€ì¥ë‹˜ì˜ ìŠ¹ì¸ í›„ Applyê°€ ì§„í–‰ë©ë‹ˆë‹¤.`
            });

  handle-missing-poc:
    needs: pre-checking
    if: needs.pre-checking.outputs.has_poc == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Update Summary for Missing POC
        run: |
          echo "## ì‘ì—… ì¤‘ë‹¨ - POC ì •ë³´ ëˆ„ë½" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${{ needs.pre-checking.outputs.resource_group }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âŒ POC ì •ë³´ê°€ ëˆ„ë½ë˜ì–´ ë°°í¬ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ì¡°ì¹˜: POC ë¼ë²¨ì„ ì¶”ê°€í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY

      - name: Remove Resource Group Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: 'resource_group'
              });
              console.log('resource_group ë¼ë²¨ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
              console.log('ë¼ë²¨ ì œê±° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', e.message);
            }

  terraform-apply:
    needs: [pre-checking, terraform-plan]
    runs-on: ubuntu-latest
    # POC ì •ë³´ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì§„í–‰
    if: needs.pre-checking.outputs.has_poc == 'true'
    environment: 
      name: production
      url: ${{ github.server_url }}/${{ github.repository }}/issues/${{ github.event.issue.number }}
    outputs:
      approval_status: ${{ steps.get_approval_status.outputs.status }}
      started: ${{ steps.mark-start.outputs.started }}
      
    env:
      ARM_USE_OIDC: true
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_resource_group_name: ${{ needs.pre-checking.outputs.resource_group }}
    
    steps:
      - name: Get Approval Status
        id: get_approval_status
        run: |
          # í™˜ê²½ ë³´í˜¸ ê²€í†  ìƒíƒœ í™•ì¸
          # GitHub Actionsì—ì„œëŠ” ì´ ê°’ì„ ì§ì ‘ ì–»ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê·¸ëƒ¥ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •
          # ì‹¤ì œë¡œëŠ” ì›Œí¬í”Œë¡œìš°ê°€ ì—¬ê¸°ê¹Œì§€ ì§„í–‰ë˜ë©´ ìŠ¹ì¸ëœ ê²ƒì„
          echo "status=approved" >> $GITHUB_OUTPUT
          
          # ìš”ì•½ ì¶”ê°€
          echo "## ìŠ¹ì¸ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- í™˜ê²½: **production**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ìŠ¹ì¸ë¨" >> $GITHUB_STEP_SUMMARY

      - name: Mark job started
        id: mark-start
        run: echo "started=true" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v3
      
      - name: 'Az CLI login with OIDC'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          
          # ìš”ì•½ ì‹œì‘
          echo "## Terraform Apply ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${TF_VAR_resource_group_name}**" >> $GITHUB_STEP_SUMMARY
          echo "- POC: **${{ needs.pre-checking.outputs.poc_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âœ… ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë¨" >> $GITHUB_STEP_SUMMARY
          
          # ë¦¬ì†ŒìŠ¤ ëª©ë¡ ì¶œë ¥ (ì„ íƒì )
          echo "### ë°°í¬ëœ ë¦¬ì†ŒìŠ¤" >> $GITHUB_STEP_SUMMARY
          terraform state list | while read -r resource; do
            echo "- \`$resource\`" >> $GITHUB_STEP_SUMMARY
          done
      
      - name: Post Apply Result to Issue
        if: ${{ success() }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue.number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `## Terraform Apply ì™„ë£Œ âœ…
              
              ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: \`${{ needs.pre-checking.outputs.resource_group }}\`
              POC: \`${{ needs.pre-checking.outputs.poc_name }}\`
              
              ì¸í”„ë¼ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`
            });

  handle-rejection:
    needs: terraform-apply
    # ìˆ˜ì •ëœ ì¡°ê±´: terraform-applyê°€ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤íŒ¨í•˜ê±°ë‚˜ ì·¨ì†Œëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: >
      always() && 
      (needs.terraform-apply.result == 'failure' || 
       needs.terraform-apply.result == 'cancelled' || 
       needs.terraform-apply.result == 'skipped') && 
      needs.terraform-apply.outputs.started != 'true' &&
      needs.pre-checking.outputs.has_poc == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update Summary for Rejection
        run: |
          echo "## ë°°í¬ ê±°ì ˆ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- ë¦¬ì†ŒìŠ¤ ê·¸ë£¹: **${{ needs.pre-checking.outputs.resource_group }}**" >> $GITHUB_STEP_SUMMARY
          echo "- POC: **${{ needs.pre-checking.outputs.poc_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: âŒ ë°°í¬ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ì¡°ì¹˜: ì´ìŠˆì— ê±°ì ˆ ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.payload.issue.number;

            // 1) ê±°ì ˆ ì½”ë©˜íŠ¸
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `## Terraform Apply ê±°ì ˆë¨ âŒ

              íŒ€ì¥ë‹˜ì´ ë°°í¬ ìš”ì²­ì„ ë°˜ë ¤í–ˆìŠµë‹ˆë‹¤.  
              ì´ìŠˆ ë‚´ìš©ì„ ìˆ˜ì •í•œ ë’¤ **'resource_group' ë¼ë²¨ì„ ë‹¤ì‹œ ë‹¬ì•„** ì¬ìš”ì²­í•´ ì£¼ì„¸ìš”.`
            });

            // 2) ê¸°ì¡´ resource_group ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner, repo, issue_number,
                name: 'resource_group'
              });
            } catch (e) {
              // ì´ë¯¸ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
            }

            // 3) ìƒíƒœ í‘œì‹œìš© ë¼ë²¨ ì¶”ê°€(ì„ íƒ)
            await github.rest.issues.addLabels({
              owner, repo, issue_number,
              labels: ['deployment-rejected']
            });

  cleanup-artifacts:
    needs: [terraform-plan, handle-rejection]
    if: always()
    runs-on: ubuntu-latest

    # ğŸŸ¢ ì•„í‹°íŒ©íŠ¸ ì‚­ì œìš© API í˜¸ì¶œ ê¶Œí•œ
    permissions:
      actions: write

    steps:
      - name: Update Summary for Cleanup
        run: |
          echo "## ì•„í‹°íŒ©íŠ¸ ì •ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "- ì‘ì—…: terraform-plan ì•„í‹°íŒ©íŠ¸ ì •ë¦¬" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: ì§„í–‰ ì¤‘..." >> $GITHUB_STEP_SUMMARY

      - name: List available artifacts
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            console.log('Available artifacts:');
            for (const artifact of artifacts.data.artifacts) {
              console.log(`- ${artifact.name} (ID: ${artifact.id})`);
            }
            
      - name: Delete terraform-plan artifact
        id: delete-artifact
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return artifact.name === "terraform-plan"
            })[0];
            
            let deleteStatus = "âŒ ì•„í‹°íŒ©íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ";
            
            if (matchArtifact) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: matchArtifact.id
              });
              console.log(`Successfully deleted artifact: terraform-plan (ID: ${matchArtifact.id})`);
              deleteStatus = "âœ… ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë¨";
            } else {
              console.log('No terraform-plan artifact found');
            }
            
            // ìš”ì•½ ì—…ë°ì´íŠ¸
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `- terraform-plan: **${deleteStatus}**\n`);
            
      - name: Final Workflow Summary
        run: |
          echo "## ì›Œí¬í”Œë¡œìš° ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì „ì²´ ìƒíƒœ: âœ… ì›Œí¬í”Œë¡œìš° ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY